<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bitcoin Trading Assistant</title>
  
  <!-- External Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --danger-gradient: linear-gradient(135deg, #ff512f 0%, #f09819 100%);
      --warning-gradient: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
      --bg-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card-gradient: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      overflow-x: hidden;
    }
    
    .glass-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .gradient-primary {
      background: var(--primary-gradient);
    }
    
    .gradient-success {
      background: var(--success-gradient);
    }
    
    .gradient-danger {
      background: var(--danger-gradient);
    }
    
    .gradient-warning {
      background: var(--warning-gradient);
    }
    
    .animate-pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .animate-glow {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
      to { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8), 0 0 40px rgba(102, 126, 234, 0.3); }
    }
    
    .floating {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .slide-in {
      animation: slideIn 0.5s ease-out forwards;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
      transform-origin: 50% 50%;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: var(--primary-gradient);
      border-radius: 3px;
    }
    
    .hover-lift {
      transition: all 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
    
    .neon-border {
      position: relative;
    }
    
    .neon-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      padding: 2px;
      background: var(--primary-gradient);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: subtract;
      -webkit-mask-composite: xor;
    }
    
    .price-card {
      position: relative;
      overflow: hidden;
    }
    
    .price-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      animation: shine 3s infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      50% { transform: translateX(0%) translateY(0%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      background: var(--glass-bg);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    
    .status-indicator {
      position: relative;
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-indicator.active {
      background: #10b981;
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
    }
    
    .status-indicator.danger {
      background: #ef4444;
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
    }
    
    @keyframes ping {
      75%, 100% {
        transform: scale(2);
        opacity: 0;
      }
    }
    
    .trade-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .trade-card:hover {
      transform: scale(1.02);
    }
    
    .metric-value {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn-gradient {
      background: var(--primary-gradient);
      border: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-gradient:active {
      transform: translateY(0);
    }
    
    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .btn-gradient:hover::before {
      left: 100%;
    }
    
    .mobile-nav {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
    }
    
    .timeframe-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: #e2e8f0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .timeframe-btn:hover {
      background: var(--primary-gradient);
      transform: translateY(-1px);
    }
    
    .timeframe-btn.active {
      background: var(--primary-gradient);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .level-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
    }
    
    .level-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .step-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
    }
    
    .step-card.completed::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--success-gradient);
    }
    
    .step-card.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--warning-gradient);
      animation: pulse 2s infinite;
    }
    
    .launch-countdown {
      font-family: 'Courier New', monospace;
      font-weight: 800;
      font-size: 2rem;
      text-align: center;
      color: #10b981;
      text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      animation: glow-text 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow-text {
      from { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
      to { text-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 0 0 25px rgba(16, 185, 129, 0.4); }
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
    }
    
    .input-field {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.3s ease;
    }
    
    .input-field:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    /* Fixed dropdown positioning */
    .more-dropdown {
      position: absolute !important;
      z-index: 50 !important;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      max-width: 400px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideInRight 0.3s ease-out forwards;
    }

    .notification.error {
      background: linear-gradient(135deg, #ff512f 0%, #f09819 100%);
    }

    .notification.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .notification.warning {
      background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
    }

    .notification-close {
      margin-left: 12px;
      cursor: pointer;
      opacity: 0.8;
    }

    .notification-close:hover {
      opacity: 1;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* Progress bar improvements */
    .progress-step {
      transition: all 0.5s ease;
    }

    .progress-step.active {
      background: var(--warning-gradient);
      transform: scale(1.05);
    }

    .progress-step.completed {
      background: var(--success-gradient);
    }

    /* Loading spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      #timeframe-selector {
        margin-top: 12px;
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 8px;
      }
      
      .timeframe-btn {
        margin-right: 4px;
        margin-bottom: 4px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .level-card {
        min-width: 160px;
      }
      
      #live-price {
        font-size: 2rem;
      }
      
      .metric-value {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 1024px) {
      #sidebar {
        width: 100%;
      }
      
      #content {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="min-h-screen text-white">
  <div id="app" class="flex flex-col h-screen overflow-hidden">
    <!-- Header -->
    <header class="glass-card mx-4 mt-4 mb-2 p-4 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full gradient-primary flex items-center justify-center">
          <i class="fab fa-bitcoin text-white text-lg"></i>
        </div>
        <h1 class="text-2xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
          Bitcoin Trading Assistant
        </h1>
      </div>
      
      <!-- Timeframe Selector -->
      <div id="timeframe-selector" class="flex flex-wrap gap-2 justify-center">
        <div class="relative">
          <button class="timeframe-btn more px-3 py-2 rounded-lg text-sm font-medium" id="more-tf-btn">
            More <i class="fas fa-chevron-down ml-1"></i>
          </button>
          <div class="more-dropdown min-w-max rounded-lg p-2" id="more-dropdown">
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="3d">3D</div>
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="8h">8H</div>
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="6h">6H</div>
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="3h">3H</div>
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="45m">45M</div>
            <div class="more-dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer text-sm" data-tf="5m">5M</div>
          </div>
        </div>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="1M">1M</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="1w">1W</button>
        <button class="timeframe-btn active px-3 py-2 rounded-lg text-sm font-medium" data-tf="1d">1D</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="4h">4H</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="2h">2H</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="1h">1H</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="30m">30M</button>
        <button class="timeframe-btn px-3 py-2 rounded-lg text-sm font-medium" data-tf="15m">15M</button>
      </div>
    </header>

    <!-- Main Content -->
    <div id="content" class="flex flex-col lg:flex-row flex-1 overflow-hidden px-4 pb-4 space-y-4 lg:space-y-0 lg:space-x-4">
      <!-- Price Display -->
      <div id="price-display" class="flex-1 overflow-y-auto custom-scrollbar space-y-6">
        <!-- Live Price Card -->
        <div id="live-price-container" class="glass-card p-6 price-card hover-lift animate-pulse-slow">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold flex items-center">
              <span class="status-indicator active"></span>
              Live Bitcoin Price
            </h2>
            <i class="fas fa-chart-line text-blue-400 text-xl"></i>
          </div>
          <div id="live-price" class="text-4xl font-bold mb-2 metric-value">Loading...</div>
          <div id="live-change" class="text-lg font-medium"></div>
        </div>

        <!-- Price Chart -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-chart-area text-purple-400 mr-3"></i>
            Price Chart - <span id="current-tf" class="text-blue-400 ml-1">1D</span>
            <div id="chart-loading" class="ml-auto hidden">
              <div class="loading-spinner"></div>
              <span class="text-sm">Loading...</span>
            </div>
          </h3>
          <div class="chart-container">
            <canvas id="price-chart" width="100%" height="300"></canvas>
          </div>
        </div>

        <!-- Key Levels -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-semibold mb-6 flex items-center">
            <i class="fas fa-layer-group text-green-400 mr-3"></i>
            Key Support & Resistance Levels
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="price-levels-container">
            <!-- Levels will be populated here -->
          </div>
        </div>

        <!-- Multi-Timeframe Analysis -->
        <div class="glass-card p-6">
          <h3 class="text-xl font-semibold mb-6 flex items-center">
            <i class="fas fa-clock text-yellow-400 mr-3"></i>
            Multi-Timeframe Analysis
          </h3>
          <div id="tf-analysis-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Analysis results will be populated here -->
          </div>
        </div>

        <div class="text-center text-gray-400 text-sm flex items-center justify-center">
          <i class="fas fa-sync-alt mr-2 animate-spin"></i>
          Data refreshes every 10 seconds
        </div>
      </div>

      <!-- Sidebar -->
      <div id="sidebar" class="w-full lg:w-96 overflow-y-auto custom-scrollbar space-y-6 hidden lg:block">
        <!-- Progress Section -->
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Trading System Progress</h3>
            <span id="progress-percent" class="text-2xl font-bold text-blue-400">0%</span>
          </div>
          
          <!-- Circular Progress -->
          <div class="flex justify-center mb-6">
            <div class="relative w-24 h-24">
              <svg class="progress-ring w-24 h-24" viewBox="0 0 120 120">
                <circle class="progress-ring-circle stroke-gray-700" 
                        stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                <circle id="progress-circle" class="progress-ring-circle stroke-blue-500" 
                        stroke-width="8" fill="transparent" r="52" cx="60" cy="60"
                        stroke-dasharray="327" stroke-dashoffset="327"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-lg font-bold" id="progress-display">0%</span>
              </div>
            </div>
          </div>

          <!-- Progress Steps -->
          <div class="space-y-2 mb-4">
            <div class="flex items-center space-x-2">
              <div class="progress-step w-4 h-4 rounded-full bg-gray-600" id="progress-step-1"></div>
              <span class="text-sm">Trend Analysis</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="progress-step w-4 h-4 rounded-full bg-gray-600" id="progress-step-2"></div>
              <span class="text-sm">Key Levels</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="progress-step w-4 h-4 rounded-full bg-gray-600" id="progress-step-3"></div>
              <span class="text-sm">Structure Break</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="progress-step w-4 h-4 rounded-full bg-gray-600" id="progress-step-4"></div>
              <span class="text-sm">Entry Confirmation</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="progress-step w-4 h-4 rounded-full bg-gray-600" id="progress-step-5"></div>
              <span class="text-sm">Risk Management</span>
            </div>
          </div>
        </div>

        <!-- Trading Steps -->
        <div class="space-y-4">
          <div class="step-card glass-card p-4 slide-in" id="step1">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-trending-up mr-2 text-green-400"></i>
              1. Trend Analysis
            </h4>
            <div id="trend-alert"></div>
          </div>

          <div class="step-card glass-card p-4 slide-in" id="step2">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-crosshairs mr-2 text-blue-400"></i>
              2. Key Levels
            </h4>
            <div id="levels-alert"></div>
          </div>

          <div class="step-card glass-card p-4 slide-in" id="step3">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-bolt mr-2 text-yellow-400"></i>
              3. Break of Structure
            </h4>
            <div id="bos-alert"></div>
          </div>

          <div class="step-card glass-card p-4 slide-in" id="step4">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-bullseye mr-2 text-purple-400"></i>
              4. Entry Confirmation
            </h4>
            <div id="entry-alert"></div>
          </div>

          <div class="step-card glass-card p-4 slide-in" id="step5">
            <h4 class="font-semibold mb-3 flex items-center">
              <i class="fas fa-shield-alt mr-2 text-red-400"></i>
              5. Risk Management
            </h4>
            
            <div class="space-y-3 mb-4">
              <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="risk1" class="form-checkbox h-5 w-5 text-blue-500 rounded">
                <span class="text-sm">Risk only 1-2% of account</span>
              </label>
              <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="risk2" class="form-checkbox h-5 w-5 text-blue-500 rounded">
                <span class="text-sm">Set stop loss (1% below/above key level)</span>
              </label>
              <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="risk3" class="form-checkbox h-5 w-5 text-blue-500 rounded">
                <span class="text-sm">1:2 Risk-Reward ratio</span>
              </label>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Account Size ($)</label>
                <input type="number" id="account-size" value="1000" class="input-field w-full p-2 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Risk (%)</label>
                <input type="number" id="risk-percent" value="1" min="0.1" max="5" step="0.1" class="input-field w-full p-2 rounded-lg">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium mb-1">Stop Loss Distance ($)</label>
                <div id="sl-distance" class="bg-gray-800 p-2 rounded-lg font-mono">10.00</div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Position Size (BTC)</label>
                <div id="position-size" class="bg-gray-800 p-2 rounded-lg font-mono">0.0100</div>
              </div>
            </div>

            <button id="calculate-btn" class="btn-gradient w-full py-3 px-4 rounded-lg mt-4 font-semibold">
              <i class="fas fa-calculator mr-2"></i>Calculate Risk
            </button>
          </div>
        </div>

        <!-- Launch Prep -->
        <div class="glass-card p-6" id="launch-prep">
          <h3 class="text-xl font-semibold mb-6 text-center flex items-center justify-center">
            <i class="fas fa-rocket mr-3 text-orange-400"></i>
            Launch Preparation
          </h3>

          <div id="launch-conditions" class="space-y-3 mb-6">
            <!-- Conditions will be populated here -->
          </div>

          <div id="countdown" class="launch-countdown mb-6">READY</div>

          <!-- Confidence Meter -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span>Confidence Level</span>
              <span id="confidence-percent">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
              <div id="confidence-fill" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-1">
              <span>Low</span>
              <span>Medium</span>
              <span>High</span>
            </div>
          </div>

          <button id="execute-btn" disabled class="btn-gradient w-full py-4 px-6 rounded-lg font-bold text-lg animate-glow disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-play mr-2"></i>EXECUTE TRADE
          </button>
        </div>

        <!-- Performance Metrics -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-chart-bar mr-3 text-blue-400"></i>
            Performance Overview
          </h3>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="text-center">
              <div class="text-sm text-gray-400">Active P/L</div>
              <div id="active-pl" class="metric-value">$0.00</div>
              <div id="active-pl-percent" class="text-sm">0%</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Total P/L</div>
              <div id="total-pl" class="metric-value">$0.00</div>
              <div id="total-pl-percent" class="text-sm">0%</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Win Rate</div>
              <div id="win-rate" class="metric-value">0%</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Completed P/L</div>
              <div id="completed-pl" class="metric-value">$0.00</div>
              <div id="completed-pl-percent" class="text-sm">0%</div>
            </div>
          </div>

          <button id="add-trade-btn" class="w-full py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors font-medium">
            <i class="fas fa-plus mr-2"></i>Add External Trade
          </button>
        </div>

        <!-- Trade History -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-history mr-3 text-purple-400"></i>
            Trade History
          </h3>
          <div class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar" id="trade-list">
            <!-- Trade history will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="mobile-nav p-4 flex justify-around lg:hidden">
      <button class="mobile-tab flex flex-col items-center space-y-1 p-3 rounded-lg bg-blue-600" data-tab="levels">
        <i class="fas fa-chart-line"></i>
        <span class="text-xs">Levels</span>
      </button>
      <button class="mobile-tab flex flex-col items-center space-y-1 p-3 rounded-lg hover:bg-white/10" data-tab="steps">
        <i class="fas fa-list-ol"></i>
        <span class="text-xs">Steps</span>
      </button>
      <button class="mobile-tab flex flex-col items-center space-y-1 p-3 rounded-lg hover:bg-white/10" data-tab="launch">
        <i class="fas fa-rocket"></i>
        <span class="text-xs">Launch</span>
      </button>
    </div>
  </div>

  <!-- Trade Modal -->
  <div id="trade-modal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold" id="modal-title">Add External Trade</h3>
        <button class="close-modal text-2xl hover:text-red-400 transition-colors">&times;</button>
      </div>

      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Trade Type</label>
            <select id="trade-type" class="input-field w-full p-2 rounded-lg">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Timeframe</label>
            <select id="trade-timeframe" class="input-field w-full p-2 rounded-lg">
              <option value="1M">1M</option>
              <option value="1w">1W</option>
              <option value="1d" selected>1D</option>
              <option value="4h">4H</option>
              <option value="2h">2H</option>
              <option value="1h">1H</option>
              <option value="30m">30M</option>
              <option value="15m">15M</option>
              <option value="3d">3D</option>
              <option value="8h">8H</option>
              <option value="6h">6H</option>
              <option value="3h">3H</option>
              <option value="45m">45M</option>
              <option value="5m">5M</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Entry Price ($)</label>
            <input type="number" id="entry-price" step="0.01" class="input-field w-full p-2 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Exit Price ($)</label>
            <input type="number" id="exit-price" step="0.01" class="input-field w-full p-2 rounded-lg">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Position Size (USDT)</label>
            <input type="number" id="position-size-input" step="0.01" class="input-field w-full p-2 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <select id="trade-status" class="input-field w-full p-2 rounded-lg">
              <option value="active">Active</option>
              <option value="target">Hit Target</option>
              <option value="stopped">Stopped Out</option>
              <option value="closed">Closed Manually</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Stop Loss ($)</label>
            <input type="number" id="stop-loss" step="0.01" class="input-field w-full p-2 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Take Profit ($)</label>
            <input type="number" id="take-profit" step="0.01" class="input-field w-full p-2 rounded-lg">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Entry Time</label>
            <input type="datetime-local" id="entry-time" class="input-field w-full p-2 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Exit Time</label>
            <input type="datetime-local" id="exit-time" class="input-field w-full p-2 rounded-lg">
          </div>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button id="save-trade-btn" class="btn-gradient flex-1 py-3 px-4 rounded-lg font-semibold">
          <i class="fas fa-save mr-2"></i>Save Trade
        </button>
        <button id="delete-trade-btn" class="bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold hidden">
          <i class="fas fa-trash mr-2"></i>Delete
        </button>
      </div>
    </div>
  </div>

  <script>
    // Enhanced Trading System with Charts
    let currentTimeframe = '1d';
    let candles = {};
    let ws;
    let lastPrice = 0;
    let priceChart;
    let progress = 0;
    let confidence = 0;
    let countdown = 5;
    let countdownInterval;
    let refreshInterval;
    
    // Data storage
    let trend = null;
    let keyLevels = [];
    let potentialTrades = [];
    let launchConditions = [];
    let tradeHistory = [];
    let activeTrade = null;
    let editingTradeId = null;

    // Notification system
    function showNotification(message, type = 'error', duration = 5000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
          <span>${message}</span>
        </div>
        <button class="notification-close">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.body.appendChild(notification);
      
      // Close button functionality
      notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });
      
      // Auto-remove after duration
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'fadeOut 0.3s ease-out forwards';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }, duration);
    }

    // Timeframe mapping for Binance API
    function getApiTimeframe(timeframe) {
      const mapping = {
        '1M': '1M',
        '1w': '1w',
        '1d': '1d',
        '4h': '4h',
        '2h': '2h',
        '1h': '1h',
        '30m': '30m',
        '15m': '15m',
        '3d': '3d',
        '8h': '8h',
        '6h': '6h',
        '3h': '3h',
        '45m': '45m',
        '5m': '5m'
      };
      return mapping[timeframe] || timeframe;
    }

    // Initialize Chart
    function initializeChart() {
      const ctx = document.getElementById('price-chart').getContext('2d');
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Bitcoin Price',
            data: [],
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              display: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            },
            y: {
              display: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Update chart with new data
    function updateChart(timeframe) {
      if (!candles[timeframe] || !priceChart) return;
      
      const data = candles[timeframe].slice(-50); // Show last 50 candles
      const labels = data.map(candle => {
        const date = new Date(candle.time * 1000);
        return date.toLocaleDateString();
      });
      const prices = data.map(candle => candle.close);
      
      priceChart.data.labels = labels;
      priceChart.data.datasets[0].data = prices;
      priceChart.update('none');
    }

    // Update progress steps visual indicators
    function updateProgressSteps() {
      const steps = [
        { id: 'progress-step-1', condition: 'trend-confirmed' },
        { id: 'progress-step-2', condition: 'key-levels' },
        { id: 'progress-step-3', condition: 'structure-break' },
        { id: 'progress-step-4', condition: 'retest-confirmed' },
        { id: 'progress-step-5', condition: 'risk-calculated' }
      ];

      steps.forEach((step, index) => {
        const element = document.getElementById(step.id);
        const condition = launchConditions.find(c => c.id === step.condition);
        
        if (condition && condition.met) {
          element.classList.remove('bg-gray-600');
          element.classList.add('completed');
        } else {
          element.classList.remove('completed', 'active');
          element.classList.add('bg-gray-600');
        }
      });

      // Calculate overall progress
      const completedSteps = launchConditions.filter(c => c.met).length;
      const totalSteps = launchConditions.length;
      const allCheckboxesChecked = document.querySelectorAll('#step5 input[type="checkbox"]:checked').length === 3;
      
      let newProgress = Math.round((completedSteps / totalSteps) * 100);
      if (allCheckboxesChecked && completedSteps === totalSteps) {
        newProgress = 100;
      }

      if (progress !== newProgress) {
        progress = newProgress;
        
        // Update circular progress
        const circle = document.getElementById('progress-circle');
        const circumference = 2 * Math.PI * 52;
        const offset = circumference - (progress / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        
        document.getElementById('progress-percent').textContent = `${progress}%`;
        document.getElementById('progress-display').textContent = `${progress}%`;
      }
    }

    // Initialize launch conditions
    function initializeLaunchConditions() {
      launchConditions = [
        { id: 'trend-confirmed', description: 'Trend confirmed on primary timeframe', met: false },
        { id: 'secondary-trend', description: 'At least 2 timeframes show same trend direction', met: false },
        { id: 'key-levels', description: 'Key support/resistance levels identified', met: false },
        { id: 'structure-break', description: 'Break of structure detected', met: false },
        { id: 'retest-confirmed', description: 'Retest of broken level confirmed', met: false },
        { id: 'risk-calculated', description: 'Risk parameters calculated', met: false },
        { id: 'confidence-level', description: 'Confidence level > 70%', met: false }
      ];
      updateLaunchConditionsDisplay();
    }

    // Update launch conditions display
    function updateLaunchConditionsDisplay() {
      const container = document.getElementById('launch-conditions');
      container.innerHTML = '';
      
      launchConditions.forEach(condition => {
        const conditionEl = document.createElement('div');
        conditionEl.className = `flex items-center space-x-3 p-3 rounded-lg ${condition.met ? 'bg-green-500/20 border border-green-500/30' : 'bg-red-500/20 border border-red-500/30'}`;
        
        conditionEl.innerHTML = `
          <i class="fas ${condition.met ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'}"></i>
          <span class="text-sm">${condition.description}</span>
        `;
        container.appendChild(conditionEl);
      });
      
      // Update execute button and progress
      const allConditionsMet = launchConditions.every(c => c.met);
      const allCheckboxesChecked = document.querySelectorAll('#step5 input[type="checkbox"]:checked').length === 3;
      
      document.getElementById('execute-btn').disabled = !(allConditionsMet && allCheckboxesChecked);
      updateProgressSteps();
      updateCountdownMessage();
    }

    // Update countdown message
    function updateCountdownMessage() {
      const countdownEl = document.getElementById('countdown');
      const allConditionsMet = launchConditions.every(c => c.met);
      const allCheckboxesChecked = document.querySelectorAll('#step5 input[type="checkbox"]:checked').length === 3;
      
      if (!allCheckboxesChecked) {
        countdownEl.textContent = "CHECKLIST INCOMPLETE";
        countdownEl.className = "launch-countdown text-yellow-400";
      } else if (!allConditionsMet) {
        countdownEl.textContent = "CONDITIONS NOT MET";
        countdownEl.className = "launch-countdown text-yellow-400";
      } else if (countdown > 0 && countdown <= 5) {
        countdownEl.textContent = countdown.toString();
        countdownEl.className = "launch-countdown text-green-400";
      } else if (countdown <= 0) {
        countdownEl.textContent = "GO FOR LAUNCH";
        countdownEl.className = "launch-countdown text-green-400";
      } else {
        countdownEl.textContent = "READY";
        countdownEl.className = "launch-countdown text-green-400";
      }
    }

    // Load data for timeframe
    function loadData(timeframe) {
      clearTimeout(refreshInterval);
      
      // Show loading indicator
      document.getElementById('chart-loading').classList.remove('hidden');
      
      const limit = 100;
      const apiTimeframe = getApiTimeframe(timeframe);
      
      fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${apiTimeframe}&limit=${limit}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          // Hide loading indicator
          document.getElementById('chart-loading').classList.add('hidden');
          
          candles[timeframe] = data.map(d => ({
            time: Math.floor(d[0] / 1000),
            open: parseFloat(d[1]),
            high: parseFloat(d[2]),
            low: parseFloat(d[3]),
            close: parseFloat(d[4]),
            volume: parseFloat(d[5])
          }));

          // Analyze the data
          analyzeTrend(timeframe);
          findKeyLevels(timeframe);
          detectStructureBreaks(timeframe);
          analyzeAllTimeframes();
          displayKeyLevels(timeframe);
          updateChart(timeframe);
          
          if (activeTrade) {
            updateActiveTradePerformance();
          }
          
          showNotification(`${timeframe} chart data loaded successfully`, 'success', 3000);
          
          refreshInterval = setTimeout(() => loadData(timeframe), 10000);
        })
        .catch(err => {
          console.error('Error loading data:', err);
          document.getElementById('chart-loading').classList.add('hidden');
          
          let errorMessage = `Failed to load ${timeframe} chart data`;
          if (err.message.includes('404')) {
            errorMessage += ': Timeframe not supported';
          } else if (err.message.includes('429')) {
            errorMessage += ': Rate limit exceeded, retrying...';
          } else {
            errorMessage += ': Network error';
          }
          
          showNotification(errorMessage, 'error');
          
          // Retry after delay for certain errors
          if (err.message.includes('429') || err.message.includes('Network')) {
            setTimeout(() => loadData(timeframe), 5000);
          }
        });
    }

    // Analyze trend
    function analyzeTrend(timeframe) {
      const tfData = candles[timeframe];
      if (!tfData || tfData.length < 50) return;
      
      const sma20 = calculateSMA(tfData, 20);
      const sma50 = calculateSMA(tfData, 50);
      
      const lastClose = tfData[tfData.length - 1].close;
      
      let alertContent = '';
      
      if (lastClose > sma20[sma20.length - 1] && lastClose > sma50[sma50.length - 1]) {
        trend = 'bullish';
        alertContent = `<div class="bg-green-500/20 border border-green-500/30 p-3 rounded-lg">
          <i class="fas fa-arrow-up text-green-400 mr-2"></i>
          ${timeframe} Bullish Trend Confirmed
        </div>`;
        
        const condition = launchConditions.find(c => c.id === 'trend-confirmed');
        if (condition) condition.met = true;
      } else if (lastClose < sma20[sma20.length - 1] && lastClose < sma50[sma50.length - 1]) {
        trend = 'bearish';
        alertContent = `<div class="bg-red-500/20 border border-red-500/30 p-3 rounded-lg">
          <i class="fas fa-arrow-down text-red-400 mr-2"></i>
          ${timeframe} Bearish Trend Confirmed
        </div>`;
        
        const condition = launchConditions.find(c => c.id === 'trend-confirmed');
        if (condition) condition.met = true;
      } else {
        trend = 'neutral';
        alertContent = `<div class="bg-yellow-500/20 border border-yellow-500/30 p-3 rounded-lg">
          <i class="fas fa-minus text-yellow-400 mr-2"></i>
          ${timeframe} Range-bound Market
        </div>`;
        
        const condition = launchConditions.find(c => c.id === 'trend-confirmed');
        if (condition) condition.met = false;
      }
      
      document.getElementById('trend-alert').innerHTML = alertContent;
      document.getElementById('step1').classList.add('completed');
      updateLaunchConditionsDisplay();
    }

    // Find key levels
    function findKeyLevels(timeframe) {
      const tfData = candles[timeframe];
      if (!tfData || tfData.length < 10) return;
      
      const levels = [];
      
      for (let i = 2; i < tfData.length - 2; i++) {
        const prev2 = tfData[i - 2];
        const prev1 = tfData[i - 1];
        const curr = tfData[i];
        const next1 = tfData[i + 1];
        const next2 = tfData[i + 2];
        
        if (curr.low < prev1.low && curr.low < next1.low && 
            curr.low < prev2.low && curr.low < next2.low) {
          levels.push({ price: curr.low, type: 'support', time: curr.time });
        }
        
        if (curr.high > prev1.high && curr.high > next1.high && 
            curr.high > prev2.high && curr.high > next2.high) {
          levels.push({ price: curr.high, type: 'resistance', time: curr.time });
        }
      }
      
      keyLevels = levels.filter((level, index) => {
        const hasCloseLevel = levels.some((l, i) => 
          i !== index && Math.abs(l.price - level.price) < level.price * 0.01
        );
        return !hasCloseLevel;
      });
      
      const condition = launchConditions.find(c => c.id === 'key-levels');
      if (condition) condition.met = keyLevels.length > 0;
      
      document.getElementById('levels-alert').innerHTML = 
        `<div class="bg-blue-500/20 border border-blue-500/30 p-3 rounded-lg">
          <i class="fas fa-layer-group text-blue-400 mr-2"></i>
          Found ${keyLevels.length} key levels on ${timeframe}
        </div>`;
      
      document.getElementById('step2').classList.add('completed');
      updateLaunchConditionsDisplay();
    }

    // Display key levels
    function displayKeyLevels(timeframe) {
      const container = document.getElementById('price-levels-container');
      container.innerHTML = '';
      
      if (!keyLevels.length) {
        container.innerHTML = '<p class="text-gray-400 text-center col-span-full">No key levels found for this timeframe.</p>';
        return;
      }
      
      const sortedLevels = [...keyLevels].sort((a, b) => b.price - a.price);
      const groupedLevels = [];
      
      sortedLevels.forEach(level => {
        const existingGroup = groupedLevels.find(group => 
          Math.abs(group.price - level.price) < group.price * 0.01
        );
        
        if (existingGroup) {
          existingGroup.count++;
          if (level.type === 'support') existingGroup.supports++;
          else existingGroup.resistances++;
        } else {
          groupedLevels.push({
            price: level.price,
            type: level.type,
            count: 1,
            supports: level.type === 'support' ? 1 : 0,
            resistances: level.type === 'resistance' ? 1 : 0,
            timeframe: timeframe
          });
        }
      });
      
      groupedLevels.forEach(level => {
        const card = document.createElement('div');
        card.className = 'level-card p-4 rounded-xl hover-lift';
        
        let levelType = level.supports > level.resistances ? 'Support' : 'Resistance';
        if (level.supports === level.resistances) levelType = 'Key Level';
        
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">${levelType} Zone</h4>
            <i class="fas ${levelType === 'Support' ? 'fa-arrow-up text-green-400' : levelType === 'Resistance' ? 'fa-arrow-down text-red-400' : 'fa-minus text-yellow-400'}"></i>
          </div>
          <div class="text-2xl font-bold mb-2 ${levelType === 'Support' ? 'text-green-400' : levelType === 'Resistance' ? 'text-red-400' : 'text-yellow-400'}">
            $${level.price.toFixed(2)}
          </div>
          <div class="text-sm text-gray-400">
            <div>Confirmed ${level.count} times</div>
            <div>${level.supports} supports / ${level.resistances} resistances</div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // Detect structure breaks
    function detectStructureBreaks(timeframe) {
      const tfData = candles[timeframe];
      if (!tfData || tfData.length < 5) return;
      
      const recentCandles = tfData.slice(-5);
      
      potentialTrades = [];
      
      keyLevels.forEach(level => {
        for (let i = 0; i < recentCandles.length; i++) {
          const candle = recentCandles[i];
          const distance = Math.abs(candle.close - level.price) / level.price;
          
          if (distance < 0.005) {
            if (level.type === 'resistance' && candle.close > level.price) {
              potentialTrades.push({
                type: 'long',
                level: level.price,
                time: candle.time,
                candleIndex: tfData.indexOf(candle),
                timeframe: timeframe
              });
            } else if (level.type === 'support' && candle.close < level.price) {
              potentialTrades.push({
                type: 'short',
                level: level.price,
                time: candle.time,
                candleIndex: tfData.indexOf(candle),
                timeframe: timeframe
              });
            }
          }
        }
      });
      
      const condition = launchConditions.find(c => c.id === 'structure-break');
      if (condition) condition.met = potentialTrades.length > 0;
      
      if (potentialTrades.length > 0) {
        const trade = potentialTrades[0];
        document.getElementById('bos-alert').innerHTML = 
          `<div class="bg-purple-500/20 border border-purple-500/30 p-3 rounded-lg">
            <i class="fas fa-bolt text-purple-400 mr-2"></i>
            Potential ${trade.type} setup detected on ${timeframe}
          </div>`;
        
        document.getElementById('step3').classList.add('completed');
        checkRetest(timeframe);
      } else {
        document.getElementById('bos-alert').innerHTML = 
          `<div class="bg-gray-500/20 border border-gray-500/30 p-3 rounded-lg">
            <i class="fas fa-clock text-gray-400 mr-2"></i>
            No break of structure detected on ${timeframe}
          </div>`;
      }
      
      updateLaunchConditionsDisplay();
    }

    // Check for retest
    function checkRetest(timeframe) {
      if (potentialTrades.length === 0) return;
      
      const tfData = candles[timeframe];
      const trade = potentialTrades.find(t => t.timeframe === timeframe);
      if (!trade || !tfData) return;
      
      const recentCandles = tfData.slice(trade.candleIndex + 1);
      
      for (let i = 0; i < recentCandles.length; i++) {
        const candle = recentCandles[i];
        
        if (trade.type === 'long' && candle.low <= trade.level && candle.close > trade.level) {
          document.getElementById('entry-alert').innerHTML = `
            <div class="bg-green-500/20 border border-green-500/30 p-3 rounded-lg">
              <i class="fas fa-check-circle text-green-400 mr-2"></i>
              <div class="font-semibold mb-2">Retest confirmed on ${timeframe}!</div>
              <div class="text-sm space-y-1">
                <div>Entry: Above $${trade.level.toFixed(2)}</div>
                <div>Stop Loss: $${(trade.level * 0.99).toFixed(2)} (1% below)</div>
                <div>Take Profit: $${(trade.level * 1.02).toFixed(2)} (1:2 RR)</div>
              </div>
            </div>
          `;
          
          const condition = launchConditions.find(c => c.id === 'retest-confirmed');
          if (condition) condition.met = true;
          
          document.getElementById('step4').classList.add('completed');
          updateLaunchConditionsDisplay();
          return;
        }
        
        if (trade.type === 'short' && candle.high >= trade.level && candle.close < trade.level) {
          document.getElementById('entry-alert').innerHTML = `
            <div class="bg-green-500/20 border border-green-500/30 p-3 rounded-lg">
              <i class="fas fa-check-circle text-green-400 mr-2"></i>
              <div class="font-semibold mb-2">Retest confirmed on ${timeframe}!</div>
              <div class="text-sm space-y-1">
                <div>Entry: Below $${trade.level.toFixed(2)}</div>
                <div>Stop Loss: $${(trade.level * 1.01).toFixed(2)} (1% above)</div>
                <div>Take Profit: $${(trade.level * 0.98).toFixed(2)} (1:2 RR)</div>
              </div>
            </div>
          `;
          
          const condition = launchConditions.find(c => c.id === 'retest-confirmed');
          if (condition) condition.met = true;
          
          document.getElementById('step4').classList.add('completed');
          updateLaunchConditionsDisplay();
          return;
        }
      }
      
      const condition = launchConditions.find(c => c.id === 'retest-confirmed');
      if (condition) condition.met = false;
      
      document.getElementById('entry-alert').innerHTML = `
        <div class="bg-yellow-500/20 border border-yellow-500/30 p-3 rounded-lg">
          <i class="fas fa-clock text-yellow-400 mr-2"></i>
          Waiting for retest confirmation on ${timeframe}...
        </div>
      `;
      
      updateLaunchConditionsDisplay();
    }

    // Analyze all timeframes
    function analyzeAllTimeframes() {
      const timeframes = ['1M', '1w', '1d', '4h', '2h', '1h', '30m', '15m'];
      let html = '';
      let bullishTimeframes = 0;
      let bearishTimeframes = 0;
      
      timeframes.forEach(tf => {
        if (!candles[tf]) return;
        
        const tfData = candles[tf];
        const lastCandle = tfData[tfData.length - 1];
        const prevCandle = tfData[tfData.length - 2];
        
        let trendDirection = 'neutral';
        let trendIcon = '➖';
        let trendColor = 'text-gray-400';
        
        if (lastCandle.close > prevCandle.close) {
          trendDirection = 'bullish';
          trendIcon = '📈';
          trendColor = 'text-green-400';
          bullishTimeframes++;
        } else if (lastCandle.close < prevCandle.close) {
          trendDirection = 'bearish';
          trendIcon = '📉';
          trendColor = 'text-red-400';
          bearishTimeframes++;
        }
        
        let volumeIcon = '🔈';
        const avgVolume = tfData.slice(-10).reduce((a, c) => a + c.volume, 0) / 10;
        if (lastCandle.volume > avgVolume * 1.5) {
          volumeIcon = '🔊';
        } else if (lastCandle.volume < avgVolume * 0.7) {
          volumeIcon = '🔇';
        }
        
        html += `
          <div class="glass-card p-4 hover-lift">
            <div class="font-semibold mb-2">${tf} Timeframe</div>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <span class="text-lg">${trendIcon}</span>
                <span class="${trendColor} font-medium">${trendDirection}</span>
              </div>
              <div class="flex items-center space-x-2">
                <span>${volumeIcon}</span>
                <span class="text-sm text-gray-400">${(lastCandle.volume / 1000).toFixed(1)}k</span>
              </div>
            </div>
          </div>
        `;
      });
      
      const condition = launchConditions.find(c => c.id === 'secondary-trend');
      if (condition) {
        condition.met = bullishTimeframes >= 2 || bearishTimeframes >= 2;
        updateLaunchConditionsDisplay();
      }
      
      document.getElementById('tf-analysis-results').innerHTML = html;
    }

    // Calculate SMA
    function calculateSMA(data, period) {
      const sma = [];
      for (let i = period - 1; i < data.length; i++) {
        let sum = 0;
        for (let j = 0; j < period; j++) {
          sum += data[i - j].close;
        }
        sma.push(sum / period);
      }
      return sma;
    }

    // Load trades from localStorage
    function loadTradesFromStorage() {
      const savedTrades = localStorage.getItem('tradeHistory');
      if (savedTrades) {
        tradeHistory = JSON.parse(savedTrades);
        tradeHistory.forEach(trade => {
          if (trade.status === 'active') {
            activeTrade = trade;
          }
        });
        updateTradeHistoryDisplay();
        updatePerformanceMetrics();
      }
    }

    // Save trades to localStorage
    function saveTradesToStorage() {
      localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));
    }

    // Update trade history display
    function updateTradeHistoryDisplay() {
      const container = document.getElementById('trade-list');
      container.innerHTML = '';
      
      if (tradeHistory.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center">No trades yet</p>';
        return;
      }
      
      tradeHistory.forEach(trade => {
        const tradeEl = document.createElement('div');
        tradeEl.className = `trade-card glass-card p-4 mb-3 cursor-pointer`;
        
        const profitLossClass = trade.profitLoss >= 0 ? 'text-green-400' : 'text-red-400';
        const profitLossSign = trade.profitLoss >= 0 ? '+' : '';
        const statusIcon = trade.status === 'target' ? 'fa-trophy text-green-400' : 
                          trade.status === 'stopped' ? 'fa-times-circle text-red-400' :
                          trade.status === 'active' ? 'fa-play-circle text-blue-400' : 'fa-circle text-gray-400';
        
        tradeEl.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center space-x-2">
              <i class="fas ${statusIcon}"></i>
              <span class="font-semibold">${trade.type.toUpperCase()} (${trade.timeframe})</span>
            </div>
            <div class="text-right">
              <div class="${profitLossClass} font-bold">${profitLossSign}$${Math.abs(trade.profitLoss).toFixed(2)}</div>
              <div class="text-sm text-gray-400">${profitLossSign}${trade.profitLossPercent.toFixed(1)}%</div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">Entry:</span>
              <span class="font-medium">$${trade.entryPrice.toFixed(2)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">${trade.status === 'active' ? 'Current' : 'Exit'}:</span>
              <span class="font-medium">${trade.status === 'active' ? `$${trade.currentPrice.toFixed(2)}` : trade.exitPrice ? `$${trade.exitPrice.toFixed(2)}` : 'N/A'}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Stop:</span>
              <span class="font-medium">$${trade.stopLoss.toFixed(2)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Target:</span>
              <span class="font-medium">$${trade.takeProfit.toFixed(2)}</span>
            </div>
          </div>
          
          <button class="edit-trade w-full mt-3 py-2 px-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors" data-id="${trade.id}">
            <i class="fas fa-edit mr-2"></i>Edit Trade
          </button>
        `;
        
        container.appendChild(tradeEl);
      });
      
      // Add event listeners to edit buttons
      document.querySelectorAll('.edit-trade').forEach(btn => {
        btn.addEventListener('click', function() {
          const tradeId = parseInt(this.dataset.id);
          editTrade(tradeId);
        });
      });
    }

    // Update performance metrics
    function updatePerformanceMetrics() {
      let activePl = 0;
      let completedPl = 0;
      let totalPl = 0;
      let winCount = 0;
      let totalCompleted = 0;
      
      tradeHistory.forEach(trade => {
        if (trade.status === 'active') {
          activePl += trade.profitLoss;
        } else {
          completedPl += trade.profitLoss;
          totalCompleted++;
          if (trade.profitLoss > 0) winCount++;
        }
      });
      
      totalPl = activePl + completedPl;
      
      const totalRisk = tradeHistory.reduce((sum, trade) => sum + trade.riskAmount, 0);
      const activePlPercent = totalRisk > 0 ? (activePl / totalRisk) * 100 : 0;
      const completedPlPercent = totalRisk > 0 ? (completedPl / totalRisk) * 100 : 0;
      const totalPlPercent = totalRisk > 0 ? (totalPl / totalRisk) * 100 : 0;
      const winRate = totalCompleted > 0 ? (winCount / totalCompleted) * 100 : 0;
      
      // Update display
      document.getElementById('active-pl').textContent = `$${activePl.toFixed(2)}`;
      document.getElementById('active-pl-percent').textContent = `${activePlPercent.toFixed(1)}%`;
      document.getElementById('completed-pl').textContent = `$${completedPl.toFixed(2)}`;
      document.getElementById('completed-pl-percent').textContent = `${completedPlPercent.toFixed(1)}%`;
      document.getElementById('total-pl').textContent = `$${totalPl.toFixed(2)}`;
      document.getElementById('total-pl-percent').textContent = `${totalPlPercent.toFixed(1)}%`;
      document.getElementById('win-rate').textContent = `${winRate.toFixed(1)}%`;
      
      // Color coding
      const colorClass = (value) => value >= 0 ? 'text-green-400' : 'text-red-400';
      
      document.getElementById('active-pl').className = `metric-value ${colorClass(activePl)}`;
      document.getElementById('active-pl-percent').className = `text-sm ${colorClass(activePlPercent)}`;
      document.getElementById('completed-pl').className = `metric-value ${colorClass(completedPl)}`;
      document.getElementById('completed-pl-percent').className = `text-sm ${colorClass(completedPlPercent)}`;
      document.getElementById('total-pl').className = `metric-value ${colorClass(totalPl)}`;
      document.getElementById('total-pl-percent').className = `text-sm ${colorClass(totalPlPercent)}`;
      document.getElementById('win-rate').className = `metric-value ${colorClass(winRate - 50)}`;
    }

    // Update active trade performance
    function updateActiveTradePerformance() {
      if (!activeTrade || !lastPrice) return;
      
      activeTrade.currentPrice = lastPrice;
      
      if (activeTrade.type === 'long') {
        activeTrade.profitLoss = (lastPrice - activeTrade.entryPrice) * activeTrade.positionSize;
      } else {
        activeTrade.profitLoss = (activeTrade.entryPrice - lastPrice) * activeTrade.positionSize;
      }
      
      activeTrade.profitLossPercent = (activeTrade.profitLoss / activeTrade.riskAmount) * 100;
      
      // Check if trade should be closed
      if ((activeTrade.type === 'long' && lastPrice <= activeTrade.stopLoss) || 
          (activeTrade.type === 'short' && lastPrice >= activeTrade.stopLoss)) {
        activeTrade.status = 'stopped';
        activeTrade.exitPrice = activeTrade.stopLoss;
        activeTrade.exitTime = new Date().toISOString();
        activeTrade = null;
      } else if ((activeTrade.type === 'long' && lastPrice >= activeTrade.takeProfit) || 
                 (activeTrade.type === 'short' && lastPrice <= activeTrade.takeProfit)) {
        activeTrade.status = 'target';
        activeTrade.exitPrice = activeTrade.takeProfit;
        activeTrade.exitTime = new Date().toISOString();
        activeTrade = null;
      }
      
      updateTradeHistoryDisplay();
      updatePerformanceMetrics();
      saveTradesToStorage();
    }

    // Connect to WebSocket for live price updates
    function connectWebSocket() {
      try {
        ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const price = parseFloat(data.c);
          const change = parseFloat(data.P);
          
          document.getElementById('live-price').textContent = `$${price.toFixed(2)}`;
          
          const liveChangeElement = document.getElementById('live-change');
          if (change >= 0) {
            liveChangeElement.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>+${change.toFixed(2)}% (24h)`;
            liveChangeElement.className = 'text-green-400 flex items-center';
          } else {
            liveChangeElement.innerHTML = `<i class="fas fa-arrow-down mr-1"></i>${change.toFixed(2)}% (24h)`;
            liveChangeElement.className = 'text-red-400 flex items-center';
          }
          
          // Price direction indicator
          const priceContainer = document.getElementById('live-price-container');
          if (price > lastPrice) {
            priceContainer.style.borderColor = '#10b981';
          } else if (price < lastPrice) {
            priceContainer.style.borderColor = '#ef4444';
          }
          
          lastPrice = price;
          
          if (activeTrade) {
            updateActiveTradePerformance();
          }
        };
        
        ws.onclose = () => {
          setTimeout(connectWebSocket, 1000);
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          showNotification('Live price connection error', 'error');
        };
      } catch (error) {
        console.error('Failed to connect WebSocket:', error);
        showNotification('Failed to connect to live price feed', 'error');
      }
    }

    // Position dropdown correctly
    function positionDropdown() {
      const button = document.getElementById('more-tf-btn');
      const dropdown = document.getElementById('more-dropdown');
      
      if (button && dropdown) {
        const rect = button.getBoundingClientRect();
        dropdown.style.top = `${rect.bottom + 8}px`;
        dropdown.style.left = `${rect.left}px`;
      }
    }

    // Event Listeners

    // Timeframe buttons
    document.querySelectorAll('.timeframe-btn:not(.more)').forEach(btn => {
      btn.addEventListener('click', function() {
        try {
          document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentTimeframe = this.dataset.tf;
          document.getElementById('current-tf').textContent = this.textContent;
          loadData(currentTimeframe);
        } catch (error) {
          console.error('Error switching timeframe:', error);
          showNotification('Failed to switch timeframe', 'error');
        }
      });
    });

    // More timeframe dropdown
    document.getElementById('more-tf-btn').addEventListener('click', function(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('more-dropdown');
      positionDropdown();
      dropdown.classList.toggle('hidden');
    });

    document.querySelectorAll('.more-dropdown-item').forEach(item => {
      item.addEventListener('click', function() {
        try {
          const timeframe = this.dataset.tf;
          document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('more-tf-btn').classList.add('active');
          currentTimeframe = timeframe;
          document.getElementById('current-tf').textContent = timeframe;
          loadData(currentTimeframe);
          document.getElementById('more-dropdown').classList.add('hidden');
        } catch (error) {
          console.error('Error switching to dropdown timeframe:', error);
          showNotification('Failed to switch timeframe', 'error');
        }
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      document.getElementById('more-dropdown').classList.add('hidden');
    });

    // Reposition dropdown on window resize
    window.addEventListener('resize', positionDropdown);

    // Mobile tabs
    document.querySelectorAll('.mobile-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        try {
          document.querySelectorAll('.mobile-tab').forEach(t => {
            t.className = 'mobile-tab flex flex-col items-center space-y-1 p-3 rounded-lg hover:bg-white/10';
          });
          this.className = 'mobile-tab flex flex-col items-center space-y-1 p-3 rounded-lg bg-blue-600';
          
          document.getElementById('price-display').style.display = 'none';
          document.getElementById('sidebar').style.display = 'none';
          
          if (this.dataset.tab === 'levels') {
            document.getElementById('price-display').style.display = 'block';
          } else {
            document.getElementById('sidebar').style.display = 'block';
            if (this.dataset.tab === 'launch') {
              document.getElementById('launch-prep').scrollIntoView({ behavior: 'smooth' });
            }
          }
        } catch (error) {
          console.error('Error switching mobile tab:', error);
          showNotification('Failed to switch tab', 'error');
        }
      });
    });

    // Risk calculator
    document.getElementById('calculate-btn').addEventListener('click', function() {
      try {
        const accountSize = parseFloat(document.getElementById('account-size').value);
        const riskPercent = parseFloat(document.getElementById('risk-percent').value);
        
        if (!accountSize || !riskPercent) {
          showNotification('Please enter valid account size and risk percentage', 'error');
          return;
        }
        
        if (potentialTrades.length > 0) {
          const trade = potentialTrades[0];
          const slDistance = trade.type === 'long' ? 
            trade.level - (trade.level * 0.99) : 
            (trade.level * 1.01) - trade.level;
          
          const riskAmount = accountSize * (riskPercent / 100);
          const positionSize = riskAmount / slDistance;
          
          document.getElementById('sl-distance').textContent = slDistance.toFixed(2);
          document.getElementById('position-size').textContent = positionSize.toFixed(6);
          
          // Check all checkboxes
          document.querySelectorAll('#step5 input[type="checkbox"]').forEach(cb => cb.checked = true);
          document.getElementById('step5').classList.add('completed');
          
          // Update risk calculated condition
          const condition = launchConditions.find(c => c.id === 'risk-calculated');
          if (condition) condition.met = true;
          
          // Update confidence
          confidence = Math.min(100, confidence + 20);
          document.getElementById('confidence-fill').style.width = `${confidence}%`;
          document.getElementById('confidence-percent').textContent = `${confidence}%`;
          
          const confidenceCondition = launchConditions.find(c => c.id === 'confidence-level');
          if (confidenceCondition) confidenceCondition.met = confidence >= 70;
          
          updateLaunchConditionsDisplay();
          showNotification('Risk parameters calculated successfully', 'success');
        } else {
          showNotification('No trade setup detected yet', 'error');
        }
      } catch (error) {
        console.error('Error calculating risk:', error);
        showNotification('Failed to calculate risk parameters', 'error');
      }
    });

    // Execute trade
    document.getElementById('execute-btn').addEventListener('click', function() {
      try {
        if (potentialTrades.length > 0) {
          const trade = potentialTrades[0];
          const accountSize = parseFloat(document.getElementById('account-size').value);
          const riskPercent = parseFloat(document.getElementById('risk-percent').value);
          const positionSize = parseFloat(document.getElementById('position-size').textContent);
          
          const entryPrice = trade.type === 'long' ? trade.level * 1.001 : trade.level * 0.999;
          const stopLoss = trade.type === 'long' ? trade.level * 0.99 : trade.level * 1.01;
          const takeProfit = trade.type === 'long' ? trade.level * 1.02 : trade.level * 0.98;
          const riskAmount = accountSize * (riskPercent / 100);
          
          const newTrade = {
            id: Date.now(),
            type: trade.type,
            timeframe: trade.timeframe,
            entryPrice: entryPrice,
            stopLoss: stopLoss,
            takeProfit: takeProfit,
            positionSize: positionSize,
            riskAmount: riskAmount,
            potentialReward: riskAmount * 2,
            status: 'active',
            entryTime: new Date().toISOString(),
            currentPrice: entryPrice,
            profitLoss: 0,
            profitLossPercent: 0
          };
          
          activeTrade = newTrade;
          tradeHistory.unshift(newTrade);
          updateTradeHistoryDisplay();
          updatePerformanceMetrics();
          saveTradesToStorage();
          
          showNotification(`Trade executed! ${trade.type.toUpperCase()} ${trade.timeframe} at $${entryPrice.toFixed(2)}`, 'success');
        } else {
          showNotification('No trade setup available for execution', 'error');
        }
      } catch (error) {
        console.error('Error executing trade:', error);
        showNotification('Failed to execute trade', 'error');
      }
    });

    // Checkbox listeners for confidence
    document.querySelectorAll('#step5 input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        try {
          confidence = Math.max(0, Math.min(100, confidence + (this.checked ? 5 : -5)));
          document.getElementById('confidence-fill').style.width = `${confidence}%`;
          document.getElementById('confidence-percent').textContent = `${confidence}%`;
          
          const allChecked = document.querySelectorAll('#step5 input[type="checkbox"]:checked').length === 3;
          const condition = launchConditions.find(c => c.id === 'risk-calculated');
          if (condition) condition.met = allChecked;
          
          const confidenceCondition = launchConditions.find(c => c.id === 'confidence-level');
          if (confidenceCondition) confidenceCondition.met = confidence >= 70;
          
          if (allChecked) {
            document.getElementById('step5').classList.add('completed');
          } else {
            document.getElementById('step5').classList.remove('completed');
          }
          
          updateLaunchConditionsDisplay();
        } catch (error) {
          console.error('Error updating checkbox:', error);
        }
      });
    });

    // Modal functions
    function openTradeModal(editMode = false) {
      try {
        const modal = document.getElementById('trade-modal');
        const modalTitle = document.getElementById('modal-title');
        const deleteBtn = document.getElementById('delete-trade-btn');
        
        if (editMode) {
          modalTitle.textContent = 'Edit Trade';
          deleteBtn.classList.remove('hidden');
        } else {
          modalTitle.textContent = 'Add External Trade';
          deleteBtn.classList.add('hidden');
          
          // Reset form
          document.getElementById('trade-type').value = 'long';
          document.getElementById('trade-timeframe').value = '1d';
          document.getElementById('entry-price').value = '';
          document.getElementById('exit-price').value = '';
          document.getElementById('position-size-input').value = '';
          document.getElementById('stop-loss').value = '';
          document.getElementById('take-profit').value = '';
          document.getElementById('entry-time').value = new Date().toISOString().slice(0, 16);
          document.getElementById('exit-time').value = new Date().toISOString().slice(0, 16);
          document.getElementById('trade-status').value = 'active';
        }
        
        modal.classList.remove('hidden');
      } catch (error) {
        console.error('Error opening trade modal:', error);
        showNotification('Failed to open trade modal', 'error');
      }
    }

    function editTrade(tradeId) {
      try {
        const trade = tradeHistory.find(t => t.id === tradeId);
        if (!trade) {
          showNotification('Trade not found', 'error');
          return;
        }
        
        editingTradeId = tradeId;
        
        document.getElementById('trade-type').value = trade.type;
        document.getElementById('trade-timeframe').value = trade.timeframe;
        document.getElementById('entry-price').value = trade.entryPrice.toFixed(2);
        document.getElementById('exit-price').value = trade.exitPrice ? trade.exitPrice.toFixed(2) : '';
        document.getElementById('position-size-input').value = trade.positionSize;
        document.getElementById('stop-loss').value = trade.stopLoss.toFixed(2);
        document.getElementById('take-profit').value = trade.takeProfit.toFixed(2);
        document.getElementById('entry-time').value = trade.entryTime ? trade.entryTime.slice(0, 16) : '';
        document.getElementById('exit-time').value = trade.exitTime ? trade.exitTime.slice(0, 16) : '';
        document.getElementById('trade-status').value = trade.status;
        
        openTradeModal(true);
      } catch (error) {
        console.error('Error editing trade:', error);
        showNotification('Failed to edit trade', 'error');
      }
    }

    function saveTrade() {
      try {
        const type = document.getElementById('trade-type').value;
        const timeframe = document.getElementById('trade-timeframe').value;
        const entryPrice = parseFloat(document.getElementById('entry-price').value);
        const exitPrice = parseFloat(document.getElementById('exit-price').value) || 0;
        const positionSize = parseFloat(document.getElementById('position-size-input').value);
        const stopLoss = parseFloat(document.getElementById('stop-loss').value);
        const takeProfit = parseFloat(document.getElementById('take-profit').value);
        const entryTime = document.getElementById('entry-time').value;
        const exitTime = document.getElementById('exit-time').value;
        const status = document.getElementById('trade-status').value;
        
        if (!entryPrice || !positionSize || !stopLoss || !takeProfit) {
          showNotification('Please fill in all required fields', 'error');
          return;
        }
        
        const riskAmount = Math.abs(entryPrice - stopLoss) * (positionSize / entryPrice);
        
        if (editingTradeId) {
          // Update existing trade
          const tradeIndex = tradeHistory.findIndex(t => t.id === editingTradeId);
          if (tradeIndex !== -1) {
            tradeHistory[tradeIndex] = {
              ...tradeHistory[tradeIndex],
              type, timeframe, entryPrice, 
              exitPrice: status !== 'active' ? exitPrice : undefined,
              positionSize, stopLoss, takeProfit, riskAmount,
              potentialReward: Math.abs(takeProfit - entryPrice) * (positionSize / entryPrice),
              status,
              entryTime: new Date(entryTime).toISOString(),
              exitTime: status !== 'active' ? new Date(exitTime).toISOString() : undefined,
              currentPrice: status === 'active' ? lastPrice || entryPrice : exitPrice,
              profitLoss: status === 'active' ? 
                (type === 'long' ? (lastPrice - entryPrice) : (entryPrice - lastPrice)) * (positionSize / entryPrice) :
                (type === 'long' ? (exitPrice - entryPrice) : (entryPrice - exitPrice)) * (positionSize / entryPrice),
              profitLossPercent: 0 // Will be calculated
            };
            
            if (status === 'active') {
              activeTrade = tradeHistory[tradeIndex];
            } else if (activeTrade && activeTrade.id === editingTradeId) {
              activeTrade = null;
            }
          }
        } else {
          // Create new trade
          const newTrade = {
            id: Date.now(),
            type, timeframe, entryPrice,
            exitPrice: status !== 'active' ? exitPrice : undefined,
            positionSize, stopLoss, takeProfit, riskAmount,
            potentialReward: Math.abs(takeProfit - entryPrice) * (positionSize / entryPrice),
            status,
            entryTime: new Date(entryTime).toISOString(),
            exitTime: status !== 'active' ? new Date(exitTime).toISOString() : undefined,
            currentPrice: status === 'active' ? lastPrice || entryPrice : exitPrice,
            profitLoss: 0,
            profitLossPercent: 0
          };
          
          tradeHistory.unshift(newTrade);
          if (status === 'active') {
            activeTrade = newTrade;
          }
        }
        
        updateTradeHistoryDisplay();
        updatePerformanceMetrics();
        saveTradesToStorage();
        closeModal();
        editingTradeId = null;
        showNotification('Trade saved successfully', 'success');
      } catch (error) {
        console.error('Error saving trade:', error);
        showNotification('Failed to save trade', 'error');
      }
    }

    function deleteTrade() {
      try {
        if (!editingTradeId) return;
        
        const tradeIndex = tradeHistory.findIndex(t => t.id === editingTradeId);
        if (tradeIndex !== -1) {
          if (activeTrade && activeTrade.id === editingTradeId) {
            activeTrade = null;
          }
          tradeHistory.splice(tradeIndex, 1);
          updateTradeHistoryDisplay();
          updatePerformanceMetrics();
          saveTradesToStorage();
          showNotification('Trade deleted successfully', 'success');
        }
        
        closeModal();
        editingTradeId = null;
      } catch (error) {
        console.error('Error deleting trade:', error);
        showNotification('Failed to delete trade', 'error');
      }
    }

    function closeModal() {
      document.getElementById('trade-modal').classList.add('hidden');
    }

    // Modal event listeners
    document.getElementById('add-trade-btn').addEventListener('click', () => openTradeModal(false));
    document.getElementById('save-trade-btn').addEventListener('click', saveTrade);
    document.getElementById('delete-trade-btn').addEventListener('click', deleteTrade);
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    
    document.getElementById('trade-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('trade-modal')) {
        closeModal();
      }
    });

    // Initialize on mobile
    if (window.innerWidth < 1024) {
      document.getElementById('sidebar').style.display = 'none';
    }

    // Initialize everything
    try {
      initializeLaunchConditions();
      initializeChart();
      loadTradesFromStorage();
      loadData(currentTimeframe);
      connectWebSocket();
      showNotification('Bitcoin Trading Assistant loaded successfully', 'success', 3000);
    } catch (error) {
      console.error('Error initializing application:', error);
      showNotification('Failed to initialize application', 'error');
    }
  </script>
</body>
</html>
